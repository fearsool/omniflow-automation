#!/usr/bin/env python3
"""
AI Email YanÄ±tlayÄ±cÄ±
Gelen emaillere AI ile profesyonel yanÄ±t Ã¼retir

Auto-generated by OmniFlow Factory
"""

import requests
import os
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from dotenv import load_dotenv
load_dotenv()

def huggingface_generate(prompt: str, model: str = "mistralai/Mistral-7B-Instruct-v0.2") -> str:
    """HuggingFace ile metin Ã¼ret"""
    API_URL = f"https://api-inference.huggingface.co/models/{model}"
    headers = {"Authorization": f"Bearer {os.getenv('HUGGINGFACE_TOKEN')}"}
    
    payload = {
        "inputs": prompt,
        "parameters": {
            "max_new_tokens": 400,
            "temperature": 0.7,
            "top_p": 0.9,
            "do_sample": True
        }
    }
    
    response = requests.post(API_URL, headers=headers, json=payload)
    if response.status_code == 200:
        result = response.json()
        if isinstance(result, list) and len(result) > 0:
            return result[0].get('generated_text', '').replace(prompt, '').strip()
    return ""

def send_email(to: str, subject: str, body: str) -> bool:
    """Email gÃ¶nder"""
    try:
        msg = MIMEMultipart()
        msg['From'] = os.getenv('SMTP_FROM')
        msg['To'] = to
        msg['Subject'] = subject
        msg.attach(MIMEText(body, 'html'))
        
        server = smtplib.SMTP(os.getenv('SMTP_HOST'), int(os.getenv('SMTP_PORT', 587)))
        server.starttls()
        server.login(os.getenv('SMTP_USER'), os.getenv('SMTP_PASS'))
        server.send_message(msg)
        server.quit()
        return True
    except Exception as e:
        print(f"Email hatasÄ±: {e}")
        return False

# ============================================
# MAIN AUTOMATION CODE
# ============================================

def generate_email_response(original_email: str, context: str = "") -> dict:
    """Email yanÄ±tÄ± Ã¼ret"""
    
    prompt = f"""AÅŸaÄŸÄ±daki emaile profesyonel bir yanÄ±t yaz:

GELEN EMAIL:
{original_email}

EK BAÄLAM:
{context if context else "Yok"}

Kurallar:
1. Profesyonel ve nazik ol
2. SorularÄ± cevapla
3. Gerekirse ek bilgi iste
4. Ä°mza ekle

Format:
Merhaba,

[yanÄ±t iÃ§eriÄŸi]

SaygÄ±larÄ±mla,
[Åirket AdÄ±]
"""
    
    response = huggingface_generate(prompt)
    
    return {
        "original": original_email[:200] + "..." if len(original_email) > 200 else original_email,
        "response": response,
        "word_count": len(response.split())
    }

def respond_and_send(to: str, subject: str, original_email: str, context: str = "") -> dict:
    """YanÄ±t Ã¼ret ve gÃ¶nder"""
    
    result = generate_email_response(original_email, context)
    
    # Email gÃ¶nder (SMTP ayarlarÄ± varsa)
    if os.getenv('SMTP_HOST'):
        success = send_email(to, f"Re: {subject}", result['response'])
    else:
        success = False
        print("âš ï¸ SMTP ayarlarÄ± yapÄ±lmamÄ±ÅŸ, email gÃ¶nderilmedi.")
    
    return {
        **result,
        "sent": success,
        "to": to,
        "subject": f"Re: {subject}"
    }

if __name__ == "__main__":
    # Test modu - sadece yanÄ±t Ã¼ret, gÃ¶nderme
    test_email = """
Merhaba,

ÃœrÃ¼nÃ¼nÃ¼zle ilgileniyorum. Fiyat ve teslimat sÃ¼resi hakkÄ±nda bilgi alabilir miyim?

TeÅŸekkÃ¼rler,
Ahmet
"""
    
    print("ğŸš€ Email yanÄ±tÄ± Ã¼retiliyor...")
    result = generate_email_response(test_email, "E-ticaret sitesi, dijital Ã¼rÃ¼n satÄ±ÅŸÄ±")
    print("=" * 50)
    print("ğŸ“§ EMAIL YANITI")
    print("=" * 50)
    print(result['response'])
    print(f"\n({result['word_count']} kelime)")
