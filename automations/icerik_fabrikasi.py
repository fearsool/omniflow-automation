#!/usr/bin/env python3
"""
Ä°Ã§erik FabrikasÄ±
Auto-generated by OmniFlow Factory
Modified to use HuggingFace API (Free)
"""

import os
import json
import time
import requests
from datetime import datetime

# ============================================
# CONFIGURATION
# ============================================
HUGGINGFACE_TOKEN = os.getenv('HUGGINGFACE_TOKEN', '')
HF_API_URL = "https://router.huggingface.co/v1/chat/completions"
HF_MODEL = "google/gemma-2-2b-it"  # Free model

SYSTEM_CONTEXT = """
Trend analizi, copywriting, gÃ¶rsel tasarÄ±m
"""

def call_huggingface(prompt: str) -> str:
    """Call HuggingFace Inference API"""
    if not HUGGINGFACE_TOKEN:
        return "Error: HUGGINGFACE_TOKEN not set"
    
    headers = {
        "Authorization": f"Bearer {HUGGINGFACE_TOKEN}",
        "Content-Type": "application/json"
    }
    
    payload = {
        "model": HF_MODEL,
        "messages": [
            {"role": "user", "content": prompt}
        ],
        "max_tokens": 1024,
        "temperature": 0.7
    }
    
    try:
        response = requests.post(HF_API_URL, headers=headers, json=payload, timeout=120)
        response.raise_for_status()
        data = response.json()
        
        if "choices" in data and len(data["choices"]) > 0:
            return data["choices"][0]["message"]["content"]
        return str(data)
    except Exception as e:
        return f"Error: {e}"

# ============================================
# WORKFLOW NODES
# ============================================

def node_0_trend_tarayici(input_data: str) -> str:
    """Node: Trend TarayÄ±cÄ± - Twitter/Instagram trendlerini bul"""
    print(f"âš™ï¸ Running: Trend TarayÄ±cÄ±")
    
    prompt = f"""Sen bir sosyal medya trend analistisin.
Rol: Twitter/Instagram Trend Analisti
GÃ¶rev: GÃ¼nÃ¼n viral trendlerini bul ve listele

BaÄŸlam: {SYSTEM_CONTEXT}
Girdi: {input_data}

Åu anki popÃ¼ler trendleri, hashtagleri ve viral konularÄ± listele.
TÃ¼rkiye'ye odaklan.
"""
    
    result = call_huggingface(prompt)
    print(f"âœ… Trend TarayÄ±cÄ± completed")
    return result


def node_1_firsat_analizi(input_data: str) -> str:
    """Node: FÄ±rsat Analizi - Markayla uyumlu trendleri filtrele"""
    print(f"âš™ï¸ Running: FÄ±rsat Analizi")
    
    prompt = f"""Sen bir marka stratejistisin.
Rol: AI FÄ±rsat Analisti
GÃ¶rev: Bu trendlerden marka iÃ§in uygun olanlarÄ± seÃ§

BaÄŸlam: {SYSTEM_CONTEXT}
Trendler: {input_data}

En uygun 3 trendi seÃ§ ve neden uygun olduklarÄ±nÄ± aÃ§Ä±kla.
"""
    
    result = call_huggingface(prompt)
    print(f"âœ… FÄ±rsat Analizi completed")
    return result


def node_2_metin_yazari(input_data: str) -> str:
    """Node: Metin YazarÄ± - Platformlara Ã¶zel caption yaz"""
    print(f"âš™ï¸ Running: Metin YazarÄ±")
    
    prompt = f"""Sen profesyonel bir copywriter'sÄ±n.
Rol: Sosyal Medya Copywriter
GÃ¶rev: Her platform iÃ§in Ã¶zel iÃ§erik yaz

SeÃ§ilen Trendler: {input_data}

Her biri iÃ§in:
1. Instagram caption (emoji dahil)
2. Twitter post (280 karakter)
3. LinkedIn paylaÅŸÄ±mÄ±

Hashtag Ã¶nerileri de ekle.
"""
    
    result = call_huggingface(prompt)
    print(f"âœ… Metin YazarÄ± completed")
    return result


def node_3_gorsel_onerici(input_data: str) -> str:
    """Node: GÃ¶rsel Ã–nerici - GÃ¶rsel konsepti ve prompt oluÅŸtur"""
    print(f"âš™ï¸ Running: GÃ¶rsel Ã–nerici")
    
    prompt = f"""Sen bir gÃ¶rsel tasarÄ±mcÄ±sÄ±n.
Rol: Design AI
GÃ¶rev: Ä°Ã§erikler iÃ§in gÃ¶rsel konsepti oluÅŸtur

Ä°Ã§erikler: {input_data}

Her iÃ§erik iÃ§in:
1. GÃ¶rsel konsepti aÃ§Ä±kla
2. Renk paleti Ã¶ner
3. AI gÃ¶rsel Ã¼retimi iÃ§in Ä°ngilizce prompt yaz (Midjourney/DALL-E formatÄ±nda)
"""
    
    result = call_huggingface(prompt)
    print(f"âœ… GÃ¶rsel Ã–nerici completed")
    return result


def node_4_icerik_paketi(input_data: str) -> str:
    """Node: Ä°Ã§erik Paketi - HazÄ±r paylaÅŸÄ±m paketi oluÅŸtur"""
    print(f"âš™ï¸ Running: Ä°Ã§erik Paketi")
    
    prompt = f"""Sen bir iÃ§erik yÃ¶neticisisin.
Rol: Content Manager
GÃ¶rev: TÃ¼m iÃ§erikleri dÃ¼zenli bir pakete hazÄ±rla

TÃ¼m Ã‡Ä±ktÄ±lar: {input_data}

Final paketi oluÅŸtur:
1. ğŸ“… PaylaÅŸÄ±m takvimi (hangi gÃ¼n, hangi saat)
2. ğŸ“ Platform bazlÄ± iÃ§erikler
3. ğŸ¨ GÃ¶rsel notlarÄ±
4. #ï¸âƒ£ Hashtag gruplarÄ±
5. ğŸ“Š Beklenen performans
"""
    
    result = call_huggingface(prompt)
    print(f"âœ… Ä°Ã§erik Paketi completed")
    return result


# ============================================
# NOTIFICATION (Optional)
# ============================================
def send_telegram_notification(message: str):
    """Send result to Telegram"""
    bot_token = os.getenv('TELEGRAM_BOT_TOKEN', '')
    chat_id = os.getenv('TELEGRAM_CHAT_ID', '')
    
    if not bot_token or not chat_id:
        print("âš ï¸ Telegram not configured")
        return
    
    try:
        url = f"https://api.telegram.org/bot{bot_token}/sendMessage"
        payload = {
            "chat_id": chat_id,
            "text": message[:4000],  # Telegram limit
            "parse_mode": "Markdown"
        }
        requests.post(url, json=payload)
        print("ğŸ“± Telegram notification sent")
    except Exception as e:
        print(f"âŒ Telegram error: {e}")


# ============================================
# MAIN EXECUTION
# ============================================
def run_workflow(initial_input: str = "Start"):
    """Execute the complete workflow"""
    print("=" * 50)
    print(f"ğŸš€ Starting: Ä°Ã§erik FabrikasÄ±")
    print(f"ğŸ“… {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print("=" * 50)
    
    current_output = initial_input
    results = {}
    
    # Step 1: Trend TarayÄ±cÄ±
    results['trend_tarayici'] = node_0_trend_tarayici(current_output)
    current_output = results['trend_tarayici']
    time.sleep(2)  # Rate limiting

    # Step 2: FÄ±rsat Analizi
    results['firsat_analizi'] = node_1_firsat_analizi(current_output)
    current_output = results['firsat_analizi']
    time.sleep(2)

    # Step 3: Metin YazarÄ±
    results['metin_yazari'] = node_2_metin_yazari(current_output)
    current_output = results['metin_yazari']
    time.sleep(2)

    # Step 4: GÃ¶rsel Ã–nerici
    results['gorsel_onerici'] = node_3_gorsel_onerici(current_output)
    current_output = results['gorsel_onerici']
    time.sleep(2)

    # Step 5: Ä°Ã§erik Paketi
    results['icerik_paketi'] = node_4_icerik_paketi(current_output)
    
    print("\n" + "=" * 50)
    print("âœ… Workflow completed!")
    print("=" * 50)
    
    # Send notification
    summary = f"""ğŸ‰ *Ä°Ã§erik FabrikasÄ± TamamlandÄ±!*

ğŸ“… {datetime.now().strftime('%Y-%m-%d %H:%M')}

ğŸ“¦ *Ä°Ã§erik Paketi:*
{results['icerik_paketi'][:1000]}...
"""
    send_telegram_notification(summary)
    
    return results


if __name__ == "__main__":
    import sys
    initial = sys.argv[1] if len(sys.argv) > 1 else "GÃ¼ncel trendleri tara ve iÃ§erik paketi oluÅŸtur"
    results = run_workflow(initial)
    
    # Save results
    output_file = f"icerik_fabrikasi_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json"
    with open(output_file, 'w', encoding='utf-8') as f:
        json.dump(results, f, ensure_ascii=False, indent=2)
    print(f"\nğŸ“„ Results saved to {output_file}")
