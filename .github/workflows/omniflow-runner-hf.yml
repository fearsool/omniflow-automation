name: OmniFlow Automation Runner - HuggingFace

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      blueprint_id:
        description: 'Blueprint ID to run (optional)'
        required: false
  
  # Every 6 hours
  schedule:
    - cron: '0 */6 * * *'

jobs:
  run-automations:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install requests python-dotenv
      
      - name: Run OmniFlow Automation Runner
        env:
          HUGGINGFACE_TOKEN: ${{ secrets.HUGGINGFACE_TOKEN }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          USE_OLLAMA: 'false'
          REQUEST_TIMEOUT: '300'
          MAX_RETRIES: '3'
        run: python runner.py
      
      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: automation-results
          path: |
            workflow_results.json
            workflow_execution.db
            automation_runner.db
      
      - name: Send success notification
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: '✅ OmniFlow Automations Completed Successfully'
          webhook_url: ${{ secrets.DISCORD_WEBHOOK }}
      
      - name: Send failure notification
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: '❌ OmniFlow Automations Failed'
          webhook_url: ${{ secrets.DISCORD_WEBHOOK }}
